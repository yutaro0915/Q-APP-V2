id: P2-API-RateLimit-Comments-Create
phase: 2
layer: API
area: RateLimit
action: Comments-Create
target_file: backend/app/routers/comments.py
test_file: backend/tests/test_rate_limit_comments.py
depends_on: ["P0-API-Middleware-RequestId-CORS", "P2-API-Router-Comments-POST"]
spec_refs:
  - "04b" # 規約（429/ヘッダ）
  - "05"  # バックエンド設計（推奨初期値）
estimated_loc: 30

specification:
  purpose: "コメント作成にレート制限を導入（10秒/1件：user+IP）"
  
  content_requirements:
    - section: "制限仕様"
      items:
        - "直近10秒に自ユーザーの作成回数を計測"
        - "超過時 429 を返却"
        - "ヘッダ: Retry-After, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset を付与"

  output_format: "FastAPI ルーター修正（依存のGuard/ミドルウェアでも可）"

constraints:
  - "再実行安全（Idempotency-Key を阻害しない）"
  - "ストアはインメモリ/DBいずれも可（テスト容易性優先）"

test_specification:
  validation:
    - "短時間に2回目のPOSTで429"
    - "429応答に必須ヘッダが含まれる"

definition_of_done:
  - "レート制限が有効"
  - "ヘッダが付与される"
  - "テストが追加されている"
