id: P3-API-Service-Attachments-LinkThread
phase: 3
layer: API
area: Service
action: Attachments-LinkThread
target_file: backend/app/services/attachments_service.py
test_file: backend/tests/test_attachments_service.py
depends_on: ["P3-API-Repo-Attachments", "P3-API-Service-Uploads-Presign"]
spec_refs:
  - "04a" # DTO/画像仕様（imageKey）
  - "07"  # S3アップロード仕様
  - "03a" # DDL（attachments, MIME CHECK, XOR）
  - "05"  # バックエンド設計
  - "01"  # ドメイン不変条件
estimated_loc: 45

specification:
  purpose: "スレッドへの画像添付サービスロジック"
  
  content_requirements:
    - section: "AttachmentServiceクラス"
      items:
        - "link_image_to_thread() メソッド（v1は1枚）"
        - "引数: thread_id, file_key, user_id"
        - "S3オブジェクト存在確認（HEAD）"
        - "attachments作成→threadに紐付け"
    
    - section: "バリデーション"
      items:
        - "最大1画像制限（P3 v1）"
        - "file_key 形式（04a正規表現）"
        - "S3にオブジェクトが存在するか確認（HEAD）"
        - "MIME: image/webp|jpeg|png"
    
    - section: "処理フロー"
      items:
        - "HEAD で size/mime/ETag(sha256) 取得"
        - "attachments レコード作成（id, key, mime, width?, height?, size, sha256）"
        - "thread_id へ紐付け（XOR制約を満たす）"
    
    - section: "エラーハンドリング"
      items:
        - "オブジェクトが存在しない→404"
        - "MIME/サイズ不正→400"
        - "既に画像が紐付いている→409"
        - "トランザクションロールバック"

  output_format: "Python サービスメソッド"

constraints:
  - "S3アクセスの最小化"
  - "アトミックな処理"
  - "適切なエラーメッセージ"

test_specification:
  validation:
    - "画像がスレッドに紐付けられること"
    - "存在しないfile_keyでエラー"
    - "5枚目でエラー"

definition_of_done:
  - "attachments_service.pyが作成されている"
  - "link_images_to_threadメソッドが実装されている"
  - "S3確認処理が実装されている"